<!DOCTYPE html>
<html lang="en-uk">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.31.1" />
  <meta name="author" content="Stuart Lacy">
  <meta name="description" content="Research Fellow">

  
  <link rel="alternate" hreflang="en-uk" href="/2017/06/27/predicting-football-results-in-2016-2017-with-machine-learning---bayesian-hierarchical-modelling/">

  
  


  

  
  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7cMerriweather%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-110705129-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="/2017/06/27/predicting-football-results-in-2016-2017-with-machine-learning---bayesian-hierarchical-modelling/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@stulacy">
  <meta property="twitter:creator" content="@stulacy">
  
  <meta property="og:site_name" content="Stuart Lacy">
  <meta property="og:url" content="/2017/06/27/predicting-football-results-in-2016-2017-with-machine-learning---bayesian-hierarchical-modelling/">
  <meta property="og:title" content="Predicting football results in 2016-2017 with machine learning - Bayesian hierarchical modelling | Stuart Lacy">
  <meta property="og:description" content="">
  <meta property="og:locale" content="en-uk">
  
  <meta property="article:published_time" content="2017-06-27T00:00:00&#43;02:00">
  
  <meta property="article:modified_time" content="2017-06-27T00:00:00&#43;02:00">
  

  

  <title>Predicting football results in 2016-2017 with machine learning - Bayesian hierarchical modelling | Stuart Lacy</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">Stuart Lacy</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        

        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/post">
            
            <span>Blog</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/publication">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">Predicting football results in 2016-2017 with machine learning - Bayesian hierarchical modelling</h1>

      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2017-06-27 00:00:00 &#43;0200 CEST" itemprop="datePublished">
      Jun 27, 2017
    </time>
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    5 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="/2017/06/27/predicting-football-results-in-2016-2017-with-machine-learning---bayesian-hierarchical-modelling/#disqus_thread"></a>
  

  

  
  

  

</div>


      <div class="article-style" itemprop="articleBody">
        

<p>And so we come to the end of another season of football, and more
importantly, Predictaball! This season has seen several large updates
that I was meaning to detail these at the start of the season but life
got in the way.</p>

<ul>
<li>The predictive model is now fully Bayesian</li>
<li>I&rsquo;ve added a betting system that identifies value bets</li>
<li>I&rsquo;ve expanded it to include the 3 other main European leagues:

<ul>
<li>La liga</li>
<li>Serie A</li>
<li>Bundesliga</li>
</ul></li>
</ul>

<p>Rather than detailing these new aspects as well as summarising the season&rsquo;s performance in one massive blog, I&rsquo;ll split this into two parts. The first (this one) will summarise the Bayesian hierarchical model that I use for predicting match outcomes and its accuracy over the course of the season. The second part will discuss the betting scheme I implemented and how rich that made me (spoilers, not very much).</p>

<h2 id="bayesian-hierarchical-model">Bayesian hierarchical model</h2>

<p>Over last summer I upgraded the Naive Bayes classifier to a fully
Bayesian hierarchical model, using the fantastic <code>rjags</code> R package to
interface with JAGS. It assumes the match outcome $O$ is distributed as
a multinomial (JAGS prefers the term <em>categorical distribution</em> as the
multi-variate generalisation of the Bernouilli trial, i.e. the
Multinomial where $n = 1$).</p>

<p>$$O_{i} \sim Multinomial(1, \phi_{i})$$
$$log(\phi_{ik}) = \alpha_{league_{i}k} + \gamma_{1k}\eta_{home_{i}} + \gamma_{2k}\eta_{away_{i}} +  \sum_{j}^{4}{\beta_{j} X_{ij}}$$</p>

<p>For $k \in {1, 2, 3}$ representing the W/D/L outcomes of a match.</p>

<p>Where:</p>

<ul>
<li>$\alpha$ is the league and outcome dependent intercept</li>
<li>$\eta$ is a team-level intercept that provides a measure of team
<strong>strength</strong></li>
<li>$X$ are 4 match-level predictors that measure the current form each
team is in, using metrics collected over the last 5 matches:

<ul>
<li># of wins for the home team</li>
<li># of losses for the home team</li>
<li># of wins for the away team</li>
<li># of losses for the away team</li>
</ul></li>
</ul>

<p>There are three levels in this model: league, team, and match. It is a
random intercepts model, since there are league and team dependent
intercepts, with the slopes on a match level. I&rsquo;m not going to provide
exact implementation details (although can provide them on request), but
I used vague priors and the last 11 seasons worth of data to fit the
model. Convergence took around 10 hours on my rather basic home server.</p>

<h2 id="match-prediction-accuracy">Match Prediction Accuracy</h2>

<h3 id="overall">Overall</h3>

<p>There have been 1176 matches this season across all 4 leagues with 678
(58%) of these outcomes being correctly predicted. This is a better
accuracy than expected, since this classifier only got 50% on the
2015-2016 season that I was using as my test set.</p>

<p>The figure below plots the overall accuracy across the season,
highlighting that there is a period of uncertainty at the start of the
season where teams adapt to their new squads, managers, and competition,
before settling down into a steady state around Christmas. It&rsquo;s
important to note that I didn&rsquo;t start Predictaball running until October
this year. This is mostly due to needing to wait until 5 games have been
completed to obtain form data.</p>

<p><img src="/img/endofseason_2017/unnamed-chunk-2-1.png" alt="Accuracy over time" /></p>

<h3 id="stratified-by-league">Stratified by league</h3>

<p>On its own, an accuracy of 58% is rather promising, but more information
about the model performance can be gained from looking at each league in
isolation.</p>

<p>The table below shows the match accuracy split by league, and suggests
that there is a significant difference in each league&rsquo;s predictability,
since the English, Spanish, and Italian leagues all have accuracies
around 58-60%, but the Bundesliga trails far behind on 51%. This is
unexpected, particularly since the prediction model accounts for
inter-league variance by having league-dependent intercepts.</p>

<p>One factor that could go some way to explaining this behaviour is <em>RB
Leipzig</em>, who were newly promoted to the Bundesliga this season but
played very well (not too unexpectedly given their recent takeover) and
came second. Because they hadn&rsquo;t played in the Bundesliga before they
were not included in the training data and therefore were not provided
with a strength distribution. Instead, for each match prediction they
were assigned a random sample from the mean team strength posterior for
the German teams. However, as was quickly apparent, they were far
stronger than an average team and so Predictaball continuously
underestimated their chances.</p>

<table>
<thead>
<tr class="header">
<th align="left">League</th>
<th align="right">Accuracy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">premiership</td>
<td align="right">62</td>
</tr>
<tr class="even">
<td align="left">laliga</td>
<td align="right">58</td>
</tr>
<tr class="odd">
<td align="left">seriea</td>
<td align="right">58</td>
</tr>
<tr class="even">
<td align="left">bundesliga1</td>
<td align="right">51</td>
</tr>
</tbody>
</table>

<p>The high accuracy on the Premier League (62%) looks very promising for
the fully Bayesian approach. This is a massive improvement on the
previous two seasons of <a href="http://stuartlacy.co.uk/2016/05/29/predictaball-end-of-season-review-for-2015-2016/" target="_blank">43% (Naive
Bayes)</a> and <a href="http://stuartlacy.co.uk/2015/10/26/predictaball-end-of-season-review/" target="_blank">48%
(Evolutionary Algorithm
classifier)</a>,
indicating that either the league was more considerably more predictable
this season or that the Bayesian framework is more adapt at identifying
trends in the data. I imagine it&rsquo;s a combination of both factors. The
particularly poor performance last season can be explained by the rather
chaotic season with Leiester winning and the reigning champions Chelsea
havng a nightmare start, however, this doesn&rsquo;t explain the 14%
difference between the current season and 2014-2015, and so the Bayesian
model deserves some of the credit.</p>

<p>The plot below displays accuracy as a function of time, split by league.
As shown before, it takes until around Christmas for the accuracy to
steady. I believe this behaviour is simply due to there being more
upsets at the start of the season as teams are adjusting to their new
squad and management, before settling into a rhythm around Christmas. I
can&rsquo;t imagine it&rsquo;s due to the model structure since the only
time-varying part of the model are the form factors for W/D/L in the
last 5 games, It would be useful if I could model this initial behaviour
better however&hellip;</p>

<p><img src="/img/endofseason_2017/unnamed-chunk-4-1.png" alt="Accuracy over time per league" /></p>

<p>Next time I&rsquo;ll discuss the betting scheme as well as planning future improvements to Predictaball.</p>

      </div>

      


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/football">football</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/soccer">soccer</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/bayesian-analysis">Bayesian analysis</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/machine-learning">machine learning</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/predictaball">Predictaball</a>
  
</div>



    </div>
  </div>

</article>



<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/2017/04/05/predicting-afl-results-with-hierarchical-bayesian-models-using-jags/">Predicting AFL results with hierarchical Bayesian models using JAGS</a></li>
    
    <li><a href="/2016/05/29/predictaball-end-of-season-review-for-2015-2016/">Predictaball end of season review for 2015-2016</a></li>
    
    <li><a href="/2015/11/24/incorporating-odds-into-predictaball/">Incorporating odds into Predictaball</a></li>
    
    <li><a href="/2015/10/26/predictaball-end-of-season-review/">Predictaball end of season review</a></li>
    
    <li><a href="/2014/08/16/predicting-football-results-with-evolutionary-algorithms/">Predicting Football results with Evolutionary Algorithms</a></li>
    
  </ul>
</div>




<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "stulacy" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Stuart Lacy &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    
    <script id="dsq-count-scr" src="//stulacy.disqus.com/count.js" async></script>
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

